<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Καταχώρηση Ιατρού</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .main-container { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        h2 { text-align: center; color: #1a73e8; margin-bottom: 25px; }
        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input[type="text"], input[type="email"] { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; box-sizing: border-box; }
        input:focus { border-color: #1a73e8; outline: none; }
        .input-group-container { display: flex; gap: 10px; align-items: stretch; }
        .input-wrapper { flex: 1; position: relative; }

        /* Κουμπιά */
        .btn-enrich, .btn-map {
            display: flex; align-items: center; justify-content: center;
            color: white; border: none; border-radius: 8px;
            width: 45px; cursor: pointer; font-size: 18px; transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .btn-enrich { background-color: #1a73e8; }
        .btn-enrich:hover { background-color: #155db5; }
        .btn-map { background-color: #ea4335; }
        .btn-map:hover { background-color: #c5221f; }
        .fa-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Autocomplete */
        #suggestions-list {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #e0e0e0; border-top: none;
            border-radius: 0 0 8px 8px; max-height: 250px; overflow-y: auto;
            z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none;
        }
        .suggestion-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; }
        .suggestion-item:hover { background-color: #f5faff; }
        .suggestion-main { font-weight: 600; font-size: 15px; }
        .suggestion-sub { font-size: 13px; color: #666; }

        .specialty-container { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .radio-label { display: flex; align-items: center; cursor: pointer; font-size: 14px; }
        input[type="radio"] { margin-right: 10px; transform: scale(1.2); cursor: pointer; }
        .btn-submit { width: 100%; padding: 12px; background-color: #34a853; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .btn-submit:hover { background-color: #2c8f45; }
    </style>
</head>
<body>

<div class="main-container">
    <h2><i class="fas fa-user-md"></i> Νέος Ιατρός</h2>

    <div class="form-group">
        <label>Ονοματεπώνυμο</label>
        <div class="input-group-container">
            <div class="input-wrapper">
                <input type="text" id="nameInput" placeholder="π.χ. Παπαδόπουλος Γεώργιος" autocomplete="off">
            </div>
            <button id="btnEnrich" class="btn-enrich" title="Ανάκτηση από Επαφές">
                <i class="fas fa-cloud-download-alt"></i>
            </button>
        </div>
    </div>

    <div class="form-group">
        <label>Διεύθυνση Ιατρείου</label>
        <div class="input-group-container">
            <div class="input-wrapper">
                <input type="text" id="addressInput" placeholder="Αυτόματη εύρεση...">
            </div>
            <button id="btnMapSearch" class="btn-map" title="Αυτόματη εύρεση διεύθυνσης από Google Maps">
                <i class="fas fa-map-marker-alt"></i>
            </button>
        </div>
    </div>

    <div class="form-group input-group-container">
        <div class="input-wrapper">
            <label>Κινητό</label>
            <input type="text" id="mobileInput" placeholder="69...">
        </div>
        <div class="input-wrapper">
            <label>Σταθερό</label>
            <input type="text" id="landlineInput" placeholder="210...">
        </div>
    </div>

    <div class="form-group">
        <label>Email</label>
        <input type="email" id="emailInput">
    </div>

    <div class="form-group">
        <label>Ειδικότητα</label>
        <div class="specialty-container">
            <label class="radio-label"><input type="radio" name="specialty" value="Παθολόγος"> Παθολόγος</label>
            <label class="radio-label"><input type="radio" name="specialty" value="Καρδιολόγος"> Καρδιολόγος</label>
            <label class="radio-label"><input type="radio" name="specialty" value="Γεν. Οικ. Ιατρός"> Γεν. Οικ. Ιατρός</label>
            <label class="radio-label"><input type="radio" name="specialty" value="Παιδίατρος"> Παιδίατρος</label>
            <label class="radio-label"><input type="radio" name="specialty" value="Άλλο" id="radioOther"> Άλλο</label>
        </div>
        <input type="text" id="specialtyText" placeholder="Γράψτε την ειδικότητα..." style="margin-top:10px; display:none;">
    </div>

    <input type="hidden" id="notesInput">
    <button class="btn-submit">Αποθήκευση Ιατρού</button>
</div>

<script>
    // --- ΡΥΘΜΙΣΗ: ΤΟ URL ΣΟΥ ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyR7sUA7ZqlI4WXQYekMnaFISSJPIaGDeCXT7KQ-MJqIserLcjWeKpaGSQ7y4QfIbS2/exec";

    const DOM = {
        name: document.getElementById("nameInput"),
        address: document.getElementById("addressInput"),
        mobile: document.getElementById("mobileInput"),
        landline: document.getElementById("landlineInput"),
        email: document.getElementById("emailInput"),
        notes: document.getElementById("notesInput"),
        specialtyText: document.getElementById("specialtyText"),
        radioOther: document.getElementById("radioOther"),
        btnEnrich: document.getElementById("btnEnrich"),
        btnMap: document.getElementById("btnMapSearch"),
        submitBtn: document.querySelector(".btn-submit")
    };

    let timeoutId = null;
    const listDiv = document.createElement("div");
    listDiv.id = "suggestions-list";
    DOM.name.parentNode.appendChild(listDiv);

    // 1. AUTOCOMPLETE
    DOM.name.addEventListener("input", function() {
        const query = this.value.trim();
        if (query.length < 2) { listDiv.style.display = "none"; return; }
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            fetch(`${SCRIPT_URL}?action=searchContacts&query=${encodeURIComponent(query)}`)
                .then(res => res.json()).then(renderSuggestions).catch(console.error);
        }, 300);
    });

    // 2. ENRICH (ΜΠΛΕ ΚΟΥΜΠΙ)
    DOM.btnEnrich.addEventListener("click", function() {
        const query = DOM.name.value.trim() || DOM.mobile.value.trim();
        if (!query) return alert("Συμπληρώστε Όνομα για αναζήτηση.");
        toggleLoading(this, true);
        fetch(`${SCRIPT_URL}?action=enrich&query=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                toggleLoading(this, false);
                if (data.found) fillForm(data);
                else alert("Δεν βρέθηκε επαφή.");
            })
            .catch(() => { toggleLoading(this, false); alert("Σφάλμα."); });
    });

    // 3. AUTO ADDRESS (ΚΟΥΜΠΙ ΧΑΡΤΗ) - ΤΩΡΑ ΑΥΤΟΜΑΤΟ
    DOM.btnMap.addEventListener("click", function() {
        const name = DOM.name.value.trim();
        if (!name) return alert("Συμπληρώστε πρώτα το όνομα.");
        
        let specialty = "";
        const sel = document.querySelector('input[name="specialty"]:checked');
        if (sel) specialty = (sel.value === "Άλλο") ? DOM.specialtyText.value : sel.value;
        
        // Ψάχνουμε "Όνομα Ειδικότητα Πόλη(προαιρετικά)"
        const query = name + " " + specialty;
        
        toggleLoading(this, true); // Δείξε spinner
        
        // Καλούμε το Script για Geocoding
        fetch(`${SCRIPT_URL}?action=getAddress&query=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                toggleLoading(this, false);
                if (data.found && data.address) {
                    DOM.address.value = data.address; // ΓΕΜΙΣΜΑ ΠΕΔΙΟΥ!
                } else {
                    alert("Δεν βρέθηκε ακριβής διεύθυνση. Δοκιμάστε να γράψετε και την πόλη δίπλα στο όνομα.");
                }
            })
            .catch(() => { toggleLoading(this, false); alert("Σφάλμα σύνδεσης με Χάρτες."); });
    });

    // Helpers
    function toggleLoading(btn, isLoading) {
        if (isLoading) {
            btn.dataset.original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner"></i>';
            btn.disabled = true;
        } else {
            btn.innerHTML = btn.dataset.original;
            btn.disabled = false;
        }
    }

    function renderSuggestions(list) {
        listDiv.innerHTML = "";
        if (!list || !list.length) { listDiv.style.display = "none"; return; }
        list.forEach(p => {
            const div = document.createElement("div");
            div.className = "suggestion-item";
            div.innerHTML = `<div class="suggestion-main">${p.name}</div><div class="suggestion-sub">${[p.specialty, p.mobile].filter(Boolean).join(" • ")}</div>`;
            div.addEventListener("click", () => { fillForm(p); listDiv.style.display = "none"; });
            listDiv.appendChild(div);
        });
        listDiv.style.display = "block";
    }

    function fillForm(data) {
        if(data.name) DOM.name.value = data.name;
        if(data.address) DOM.address.value = data.address;
        if(data.mobile) DOM.mobile.value = data.mobile;
        if(data.landline) DOM.landline.value = data.landline;
        if(data.email) DOM.email.value = data.email;
        if(data.notes) DOM.notes.value = data.notes;
        if (data.specialty) {
            const radio = document.querySelector(`input[name="specialty"][value="${data.specialty}"]`);
            if (radio) { radio.checked = true; DOM.specialtyText.style.display = "none"; }
            else { DOM.radioOther.checked = true; DOM.specialtyText.value = data.specialty; DOM.specialtyText.style.display = "block"; }
        }
    }
    
    // UI Events
    document.querySelectorAll('input[name="specialty"]').forEach(r => {
        r.addEventListener('change', (e) => {
            DOM.specialtyText.style.display = (e.target.value === "Άλλο") ? "block" : "none";
        });
    });
    document.addEventListener("click", (e) => {
        if (!DOM.name.contains(e.target) && !listDiv.contains(e.target)) listDiv.style.display = "none";
    });
</script>

</body>
</html>
