<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Data App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .main-container { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 600px; margin-bottom: 30px; border-top: 5px solid #1a73e8; }
        h2 { text-align: center; color: #1a73e8; margin-bottom: 25px; }

        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input[type="text"], input[type="email"] { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: #1a73e8; outline: none; }
        .input-group-container { display: flex; gap: 10px; }
        .input-wrapper { flex: 1; position: relative; }

        .btn-tool { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; flex-shrink: 0; transition: 0.2s; }
        .btn-enrich { background-color: #1a73e8; } .btn-enrich:hover { background-color: #155db5; }
        .btn-map { background-color: #ea4335; } .btn-map:hover { background-color: #c5221f; }
        
        #suggestions-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .suggestion-item:hover { background: #f5faff; }
        
        .specialty-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; }
        .radio-label { display: flex; align-items: center; cursor: pointer; font-size: 13px; background: #f8f9fa; padding: 8px 12px; border-radius: 20px; border: 1px solid #dee2e6; transition: background 0.2s; }
        .radio-label:hover { background: #e9ecef; }
        input[type="radio"]:checked + span { font-weight: bold; color: #1a73e8; }
        input[type="radio"] { margin-right: 8px; }

        .btn-submit { width: 100%; padding: 14px; background-color: #34a853; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-submit:hover { background-color: #2c8f45; }
        .btn-cancel { width: 100%; padding: 14px; background-color: #f44336; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; display: none; }

        .public-sector-toggle { margin-bottom: 15px; background: #e8f0fe; padding: 10px; border-radius: 8px; display: flex; align-items: center; cursor: pointer; border: 1px solid #d2e3fc; }
        .public-sector-toggle input { margin-right: 10px; transform: scale(1.3); }
        .public-sector-fields { display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px; }
        .schedule-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; align-items: center; margin-bottom: 5px; }
        .schedule-grid label { margin: 0; font-weight: normal; font-size: 14px; }

        .db-container { width: 100%; max-width: 600px; margin-top: 20px; }
        .doctor-card { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid #1a73e8; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
        .doc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .doc-header h3 { margin: 0; font-size: 16px; color: #333; }
        .doc-spec { font-size: 13px; background: #e8f0fe; color: #1a73e8; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
        .doc-details p { margin: 3px 0; font-size: 14px; color: #555; }
        .doc-details i { width: 20px; color: #888; text-align: center; }
        
        /* ÎÎ•ÎŸ: Î£Ï„Ï…Î» Î³Î¹Î± Ï„Î¿ Link Ï„Î¿Ï… Î§Î¬ÏÏ„Î· ÏƒÏ„Î· Î»Î¯ÏƒÏ„Î± */
        .map-link { text-decoration: none; color: #555; transition: color 0.2s; }
        .map-link:hover { color: #ea4335; font-weight: 500; }
        .map-link i { color: #ea4335; } /* ÎšÏŒÎºÎºÎ¹Î½Î· Ï€Î¹Î½Î­Î¶Î± */

        .edit-btn { position: absolute; top: 15px; right: 15px; background: white; border: 1px solid #ccc; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #555; }
        .edit-btn:hover { background: #1a73e8; color: white; border-color: #1a73e8; }

        .refresh-btn { background: none; border: none; color: #1a73e8; cursor: pointer; font-weight: bold; margin-bottom: 10px; float: right; }
        .fa-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="main-container">
    <h2 id="formTitle"><i class="fas fa-user-md"></i> ÎÎ­Î¿Ï‚ Î™Î±Ï„ÏÏŒÏ‚</h2>

    <div class="form-group">
        <label>ÎŸÎ½Î¿Î¼Î±Ï„ÎµÏ€ÏÎ½Ï…Î¼Î¿</label>
        <div class="input-group-container">
            <div class="input-wrapper">
                <input type="text" id="nameInput" placeholder="Ï€.Ï‡. Î Î±Ï€Î±Î´ÏŒÏ€Î¿Ï…Î»Î¿Ï‚ Î“ÎµÏÏÎ³Î¹Î¿Ï‚" autocomplete="off">
            </div>
            <button id="btnEnrich" class="btn-tool btn-enrich" title="Î‘Î½Î¬ÎºÏ„Î·ÏƒÎ· Î±Ï€ÏŒ Î•Ï€Î±Ï†Î­Ï‚"><i class="fas fa-cloud-download-alt"></i></button>
        </div>
    </div>

    <div class="form-group">
        <label>Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î™Î±Ï„ÏÎµÎ¯Î¿Ï…</label>
        <div class="input-group-container">
            <div class="input-wrapper">
                <input type="text" id="addressInput" placeholder="Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· ÎµÏÏÎµÏƒÎ·...">
            </div>
            <button id="btnMapSearch" class="btn-tool btn-map" title="Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î•ÏÏÎµÏƒÎ· Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·Ï‚ (API)"><i class="fas fa-map-marker-alt"></i></button>
        </div>
    </div>

    <div class="input-group-container form-group">
        <div class="input-wrapper">
            <label>ÎšÎ¹Î½Î·Ï„ÏŒ</label>
            <input type="text" id="mobileInput" placeholder="69...">
        </div>
        <div class="input-wrapper">
            <label>Î£Ï„Î±Î¸ÎµÏÏŒ</label>
            <input type="text" id="landlineInput" placeholder="210...">
        </div>
    </div>

    <div class="form-group">
        <label>Email</label>
        <input type="email" id="emailInput">
    </div>

    <div class="form-group">
        <label>Î•Î¹Î´Î¹ÎºÏŒÏ„Î·Ï„Î±</label>
        <div class="specialty-container">
            <label class="radio-label"><input type="radio" name="specialty" value="Î“ÎµÎ½Î¹ÎºÏŒÏ‚ Î™Î±Ï„ÏÏŒÏ‚"> <span>Î“ÎµÎ½Î¹ÎºÏŒÏ‚ Î™Î±Ï„ÏÏŒÏ‚</span></label>
            <label class="radio-label"><input type="radio" name="specialty" value="ÎšÎ±ÏÎ´Î¹Î¿Î»ÏŒÎ³Î¿Ï‚"> <span>ÎšÎ±ÏÎ´Î¹Î¿Î»ÏŒÎ³Î¿Ï‚</span></label>
            <label class="radio-label"><input type="radio" name="specialty" value="Î“ÎµÎ½. Î§ÎµÎ¹ÏÎ¿Ï…ÏÎ³ÏŒÏ‚"> <span>Î“ÎµÎ½. Î§ÎµÎ¹ÏÎ¿Ï…ÏÎ³ÏŒÏ‚</span></label>
            <label class="radio-label"><input type="radio" name="specialty" value="Î‘Î³Î³ÎµÎ¹Î¿Î»ÏŒÎ³Î¿Ï‚ /Î§ÎµÎ¹ÏÎ¿Ï…ÏÎ³ÏŒÏ‚"> <span>Î‘Î³Î³ÎµÎ¹Î¿Î»ÏŒÎ³Î¿Ï‚ /Î§ÎµÎ¹ÏÎ¿Ï…ÏÎ³ÏŒÏ‚</span></label>
            <label class="radio-label"><input type="radio" name="specialty" value="Î Î½ÎµÏ…Î¼Î¿Î½Î¿Î»ÏŒÎ³Î¿Ï‚"> <span>Î Î½ÎµÏ…Î¼Î¿Î½Î¿Î»ÏŒÎ³Î¿Ï‚</span></label>
            <label class="radio-label"><input type="radio" name="specialty" value="Î Î±Î¸Î¿Î»ÏŒÎ³Î¿Ï‚"> <span>Î Î±Î¸Î¿Î»ÏŒÎ³Î¿Ï‚</span></label>
            <label class="radio-label"><input type="radio" name="specialty" value="ÎŸÏÎ¸Î¿Ï€ÎµÎ´Î¹ÎºÏŒÏ‚"> <span>ÎŸÏÎ¸Î¿Ï€ÎµÎ´Î¹ÎºÏŒÏ‚</span></label>
            <label class="radio-label"><input type="radio" name="specialty" value="Î“Ï…Î½Î±Î¹ÎºÎ¿Î»ÏŒÎ³Î¿Ï‚"> <span>Î“Ï…Î½Î±Î¹ÎºÎ¿Î»ÏŒÎ³Î¿Ï‚</span></label>
            <label class="radio-label"><input type="radio" name="specialty" value="Î†Î»Î»Î¿" id="radioOther"> <span>Î†Î»Î»Î¿</span></label>
        </div>
        <input type="text" id="specialtyText" placeholder="Î“ÏÎ¬ÏˆÏ„Îµ Ï„Î·Î½ ÎµÎ¹Î´Î¹ÎºÏŒÏ„Î·Ï„Î±..." style="margin-top:10px; display:none; width:100%;">
    </div>

    <div class="public-sector-toggle">
        <label style="margin:0; width:100%; cursor:pointer; display:flex; align-items:center;">
            <input type="checkbox" id="publicSectorCheck"> ğŸ¥ Î™Î±Ï„ÏÏŒÏ‚ Î”Î·Î¼Î¿ÏƒÎ¯Î¿Ï… (ÎÎ¿ÏƒÎ¿ÎºÎ¿Î¼ÎµÎ¯Î¿ / Îš.Î¥.)
        </label>
    </div>

    <div id="publicSectorFields" class="public-sector-fields">
        <div class="form-group">
            <label>ÎŸÏÎ³Î±Î½Î¹ÏƒÎ¼ÏŒÏ‚ (ÎÎ¿ÏƒÎ¿ÎºÎ¿Î¼ÎµÎ¯Î¿ / ÎšÎ­Î½Ï„ÏÎ¿ Î¥Î³ÎµÎ¯Î±Ï‚)</label>
            <input type="text" id="affiliationInput" placeholder="Ï€.Ï‡. Îš.Î¥. Î‘ÏÎ¹Î´Î±Î¯Î±Ï‚">
        </div>
        
        <label style="margin-bottom:10px;">ğŸ“… Î ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î•Ï€Î¹ÏƒÎºÎ­ÏˆÎµÏ‰Î½ ÏƒÏ„Î± Î§Ï‰ÏÎ¹Î¬:</label>
        <div class="schedule-grid"><label>Î”ÎµÏ…Ï„Î­ÏÎ±:</label><input type="text" id="villageMon" placeholder="Î§Ï‰ÏÎ¹ÏŒ..."></div>
        <div class="schedule-grid"><label>Î¤ÏÎ¯Ï„Î·:</label><input type="text" id="villageTue" placeholder="Î§Ï‰ÏÎ¹ÏŒ..."></div>
        <div class="schedule-grid"><label>Î¤ÎµÏ„Î¬ÏÏ„Î·:</label><input type="text" id="villageWed" placeholder="Î§Ï‰ÏÎ¹ÏŒ..."></div>
        <div class="schedule-grid"><label>Î Î­Î¼Ï€Ï„Î·:</label><input type="text" id="villageThu" placeholder="Î§Ï‰ÏÎ¹ÏŒ..."></div>
        <div class="schedule-grid"><label>Î Î±ÏÎ±ÏƒÎºÎµÏ…Î®:</label><input type="text" id="villageFri" placeholder="Î§Ï‰ÏÎ¹ÏŒ..."></div>
    </div>

    <input type="hidden" id="notesInput">
    
    <button class="btn-submit" id="submitBtn">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î™Î±Ï„ÏÎ¿Ï</button>
    <button class="btn-cancel" id="cancelBtn" onclick="resetEditing()">Î‘ÎºÏÏÏ‰ÏƒÎ· Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚</button>
</div>

<div class="db-container">
    <div style="overflow: hidden; margin-bottom: 10px;">
        <h3 style="float:left; margin:0;">ğŸ—‚ï¸ Î’Î¬ÏƒÎ· Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½</h3>
        <button class="refresh-btn" onclick="loadDoctors()">ğŸ”„ Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</button>
    </div>
    <div id="doctorsListLoader" style="display:none; text-align:center; padding:20px;"><i class="fas fa-spinner fa-2x"></i></div>
    <div id="doctorsListContainer"></div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbztdWp7vOsB12PChcZyklXSHCBzGQJZfs6tRhksvXvW6rNp55uC-165EREw0gukjXmR/exec";

    let editingId = null;

    const DOM = {
        title: document.getElementById("formTitle"),
        name: document.getElementById("nameInput"),
        address: document.getElementById("addressInput"),
        mobile: document.getElementById("mobileInput"),
        landline: document.getElementById("landlineInput"),
        email: document.getElementById("emailInput"),
        notes: document.getElementById("notesInput"),
        specialtyText: document.getElementById("specialtyText"),
        submitBtn: document.getElementById("submitBtn"),
        cancelBtn: document.getElementById("cancelBtn"),
        btnEnrich: document.getElementById("btnEnrich"),
        btnMap: document.getElementById("btnMapSearch"),
        listContainer: document.getElementById("doctorsListContainer"),
        loader: document.getElementById("doctorsListLoader"),
        publicCheck: document.getElementById("publicSectorCheck"),
        publicFields: document.getElementById("publicSectorFields"),
        affiliation: document.getElementById("affiliationInput"),
        villages: {
            mon: document.getElementById("villageMon"),
            tue: document.getElementById("villageTue"),
            wed: document.getElementById("villageWed"),
            thu: document.getElementById("villageThu"),
            fri: document.getElementById("villageFri")
        }
    };

    DOM.publicCheck.addEventListener("change", function() {
        DOM.publicFields.style.display = this.checked ? "block" : "none";
    });

    // 1. SAVE / UPDATE
    DOM.submitBtn.addEventListener("click", function() {
        const name = DOM.name.value.trim();
        if (!name) return alert("Î Î±ÏÎ±ÎºÎ±Î»Ï ÏƒÏ…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ ÏŒÎ½Î¿Î¼Î±.");

        let specialty = "";
        const selRadio = document.querySelector('input[name="specialty"]:checked');
        if (selRadio) specialty = (selRadio.value === "Î†Î»Î»Î¿") ? DOM.specialtyText.value : selRadio.value;

        const villageSchedule = {
            Mon: DOM.villages.mon.value,
            Tue: DOM.villages.tue.value,
            Wed: DOM.villages.wed.value,
            Thu: DOM.villages.thu.value,
            Fri: DOM.villages.fri.value
        };

        const doctorData = {
            id: editingId || Date.now(), 
            name: name,
            address: DOM.address.value,
            mobile: DOM.mobile.value,
            landline: DOM.landline.value,
            email: DOM.email.value,
            specialties: [specialty].filter(Boolean),
            notes: DOM.notes.value,
            affiliation: DOM.publicCheck.checked ? DOM.affiliation.value : "",
            villageSchedule: DOM.publicCheck.checked ? villageSchedule : {}
        };

        const originalText = this.innerText;
        this.innerText = "â³ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·...";
        this.disabled = true;

        fetch(SCRIPT_URL, {
            method: "POST",
            mode: "no-cors", 
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ doctors: [doctorData] }) 
        })
        .then(() => {
            alert(editingId ? "âœ… Î•Î½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ!" : "âœ… Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ!");
            resetEditing();
            this.innerText = originalText;
            this.disabled = false;
            loadDoctors();
        })
        .catch(err => {
            console.error(err);
            alert("âŒ Î£Ï†Î¬Î»Î¼Î±.");
            this.innerText = originalText;
            this.disabled = false;
        });
    });

    // 2. LOAD DOCTORS (ÎœÎµ Clickable Map Link)
    function loadDoctors() {
        DOM.loader.style.display = "block";
        DOM.listContainer.innerHTML = "";

        fetch(SCRIPT_URL) 
            .then(res => res.json())
            .then(data => {
                DOM.loader.style.display = "none";
                if (!data || data.length === 0) {
                    DOM.listContainer.innerHTML = "<p style='text-align:center; color:#999;'>ÎšÎµÎ½Î® Î»Î¯ÏƒÏ„Î±.</p>";
                    return;
                }
                
                data.forEach(doc => {
                    const card = document.createElement("div");
                    card.className = "doctor-card";
                    const spec = (doc.specialties && doc.specialties.length) ? doc.specialties.join(", ") : "Î§Ï‰ÏÎ¯Ï‚ ÎµÎ¹Î´Î¹ÎºÏŒÏ„Î·Ï„Î±";
                    const phones = [doc.mobile, doc.landline].filter(Boolean).join(" â€¢ ");
                    
                    let publicInfo = "";
                    if(doc.affiliation) publicInfo += `<p style="color:#e67e22; font-weight:bold;"><i class="fas fa-hospital"></i> ${doc.affiliation}</p>`;

                    // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Google Maps Link
                    // Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·, Î²Î¬Î¶Î¿Ï…Î¼Îµ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Î³Î¹Î± Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·
                    const mapQuery = encodeURIComponent((doc.address || "") + " " + doc.name);
                    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${mapQuery}`;

                    card.innerHTML = `
                        <button class="edit-btn" title="Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±"><i class="fas fa-pencil-alt"></i></button>
                        <div class="doc-header">
                            <h3>${doc.name}</h3>
                            <span class="doc-spec">${spec}</span>
                        </div>
                        <div class="doc-details">
                            ${publicInfo}
                            <p>
                                <a href="${mapUrl}" target="_blank" class="map-link" title="Î†Î½Î¿Î¹Î³Î¼Î± ÏƒÏ„Î¿ Google Maps">
                                    <i class="fas fa-map-marker-alt"></i> ${doc.address || "Î§Ï‰ÏÎ¯Ï‚ Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·"}
                                </a>
                            </p>
                            <p><i class="fas fa-phone"></i> ${phones || "-"}</p>
                        </div>
                    `;
                    
                    card.querySelector(".edit-btn").addEventListener("click", () => editDoctor(doc));
                    DOM.listContainer.appendChild(card);
                });
            })
            .catch(err => {
                DOM.loader.style.display = "none";
                DOM.listContainer.innerHTML = "<p style='color:red;'>Î£Ï†Î¬Î»Î¼Î±.</p>";
            });
    }

    // 3. EDIT & RESET
    function editDoctor(doc) {
        editingId = doc.id;
        DOM.title.innerHTML = `<i class="fas fa-edit"></i> Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±: ${doc.name}`;
        DOM.submitBtn.innerText = "Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î™Î±Ï„ÏÎ¿Ï";
        DOM.submitBtn.style.backgroundColor = "#e67e22";
        DOM.cancelBtn.style.display = "block";

        DOM.name.value = doc.name || "";
        DOM.address.value = doc.address || "";
        DOM.mobile.value = doc.mobile || "";
        DOM.landline.value = doc.landline || "";
        DOM.email.value = doc.email || "";
        DOM.notes.value = doc.notes || "";

        const spec = (doc.specialties && doc.specialties.length) ? doc.specialties[0] : "";
        const radio = document.querySelector(`input[name="specialty"][value="${spec}"]`);
        if (radio) { 
            radio.checked = true; 
            DOM.specialtyText.style.display = "none"; 
        } else if (spec) { 
            document.getElementById("radioOther").checked = true; 
            DOM.specialtyText.value = spec; 
            DOM.specialtyText.style.display = "block"; 
        }

        if (doc.affiliation || (doc.villageSchedule && Object.keys(doc.villageSchedule).length > 0)) {
            DOM.publicCheck.checked = true;
            DOM.publicFields.style.display = "block";
            DOM.affiliation.value = doc.affiliation || "";
            if (doc.villageSchedule) {
                DOM.villages.mon.value = doc.villageSchedule.Mon || "";
                DOM.villages.tue.value = doc.villageSchedule.Tue || "";
                DOM.villages.wed.value = doc.villageSchedule.Wed || "";
                DOM.villages.thu.value = doc.villageSchedule.Thu || "";
                DOM.villages.fri.value = doc.villageSchedule.Fri || "";
            }
        } else {
            DOM.publicCheck.checked = false;
            DOM.publicFields.style.display = "none";
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetEditing() {
        editingId = null;
        clearForm();
        DOM.title.innerHTML = `<i class="fas fa-user-md"></i> ÎÎ­Î¿Ï‚ Î™Î±Ï„ÏÏŒÏ‚`;
        DOM.submitBtn.innerText = "Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î™Î±Ï„ÏÎ¿Ï";
        DOM.submitBtn.style.backgroundColor = "#34a853";
        DOM.cancelBtn.style.display = "none";
    }

    // Tools
    let timeoutId = null;
    const listDiv = document.createElement("div");
    listDiv.id = "suggestions-list";
    DOM.name.parentNode.appendChild(listDiv);

    DOM.name.addEventListener("input", function() {
        const query = this.value.trim();
        if (query.length < 2) { listDiv.style.display = "none"; return; }
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            fetch(`${SCRIPT_URL}?action=searchContacts&query=${encodeURIComponent(query)}`)
                .then(res => res.json()).then(renderSuggestions).catch(console.error);
        }, 300);
    });

    DOM.btnEnrich.addEventListener("click", function() {
        const query = DOM.name.value.trim() || DOM.mobile.value.trim();
        if (!query) return alert("Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ ÏŒÎ½Î¿Î¼Î±.");
        toggleLoading(this, true);
        fetch(`${SCRIPT_URL}?action=enrich&query=${encodeURIComponent(query)}`)
            .then(res => res.json()).then(data => {
                toggleLoading(this, false);
                if (data.found) fillForm(data); else alert("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÎµÏ€Î±Ï†Î®.");
            }).catch(() => { toggleLoading(this, false); alert("Error."); });
    });

    DOM.btnMap.addEventListener("click", function() {
        const name = DOM.name.value.trim();
        if (!name) return alert("Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ ÏŒÎ½Î¿Î¼Î±.");
        let spec = "";
        const s = document.querySelector('input[name="specialty"]:checked');
        if(s) spec = (s.value === "Î†Î»Î»Î¿") ? DOM.specialtyText.value : s.value;
        const query = name + " " + spec;
        toggleLoading(this, true);
        fetch(`${SCRIPT_URL}?action=getAddress&query=${encodeURIComponent(query)}`)
            .then(res => res.json()).then(data => {
                toggleLoading(this, false);
                if(data.found && data.address) DOM.address.value = data.address;
                else alert("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î±ÎºÏÎ¹Î²Î®Ï‚ Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·.");
            }).catch(() => { toggleLoading(this, false); alert("Error."); });
    });

    function renderSuggestions(list) {
        listDiv.innerHTML = "";
        if(!list || !list.length) { listDiv.style.display = "none"; return; }
        list.forEach(p => {
            const div = document.createElement("div");
            div.className = "suggestion-item";
            div.innerHTML = `<b>${p.name}</b><br><small>${p.specialty || ""} ${p.mobile || ""}</small>`;
            div.addEventListener("click", () => { fillForm(p); listDiv.style.display = "none"; });
            listDiv.appendChild(div);
        });
        listDiv.style.display = "block";
    }

    function fillForm(data) {
        if(data.name) DOM.name.value = data.name;
        if(data.address) DOM.address.value = data.address;
        if(data.mobile) DOM.mobile.value = data.mobile;
        if(data.landline) DOM.landline.value = data.landline;
        if(data.email) DOM.email.value = data.email;
        if(data.notes) DOM.notes.value = data.notes;
        if (data.specialty) {
            const radio = document.querySelector(`input[name="specialty"][value="${data.specialty}"]`);
            if (radio) { radio.checked = true; DOM.specialtyText.style.display = "none"; }
            else { document.getElementById("radioOther").checked = true; DOM.specialtyText.value = data.specialty; DOM.specialtyText.style.display = "block"; }
        }
    }

    function clearForm() {
        DOM.name.value = ""; DOM.address.value = ""; DOM.mobile.value = ""; 
        DOM.landline.value = ""; DOM.email.value = ""; DOM.notes.value = ""; DOM.specialtyText.value = "";
        DOM.affiliation.value = "";
        DOM.villages.mon.value = ""; DOM.villages.tue.value = ""; DOM.villages.wed.value = "";
        DOM.villages.thu.value = ""; DOM.villages.fri.value = "";
        DOM.publicCheck.checked = false; DOM.publicFields.style.display = "none";
        document.querySelectorAll('input[name="specialty"]').forEach(r => r.checked = false);
    }

    function toggleLoading(btn, isLoading) {
        if(isLoading) { btn.dataset.html = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner"></i>'; btn.disabled = true; }
        else { btn.innerHTML = btn.dataset.html; btn.disabled = false; }
    }

    document.querySelectorAll('input[name="specialty"]').forEach(r => {
        r.addEventListener('change', (e) => DOM.specialtyText.style.display = (e.target.value === "Î†Î»Î»Î¿") ? "block" : "none");
    });
    document.addEventListener("click", (e) => { if (!DOM.name.contains(e.target) && !listDiv.contains(e.target)) listDiv.style.display = "none"; });

    window.addEventListener("DOMContentLoaded", loadDoctors);
</script>

</body>
</html>
